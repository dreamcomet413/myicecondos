(function(e){function r(t,n){e.getJSON(t,function(e){if(e.authenticationResultCode==="ValidCredentials"&&e.resourceSets&&e.resourceSets.length>0&&e.resourceSets[0].estimatedTotal>0){n(e.resourceSets,"OK")}else{n(null,"ZERO_RESULTS")}}).error(function(){n(null,"ERROR")})}var t="http://dev.virtualearth.net/REST/v1/Locations/{0}?output=json&jsonp=?&key={1}";var n="http://dev.virtualearth.net/REST/v1/Routes?wp.0={0}&wp.1={1}&routePathOutput=Points&output=json&jsonp=?&key={2}";e.a=function(t,n,r){e[t]=e[t]||{};e[t][n]=function(e,t){if(arguments.length){this._setup(e,t)}};e[t][n].prototype=r;e.fn[n]=function(r){var i=this,s=Array.prototype.slice.call(arguments,1),o=typeof r==="string";if(o&&r.substring(0,1)==="_"){return i}this.each(function(){var u=e.data(this,n)?e.data(this,n):e.data(this,n,new e[t][n](r,this));if(o){i=u[r].apply(u,s)}});return i}};e.a("ui","gmap",{options:{center:new Microsoft.Maps.Location(0,0),zoom:5},option:function(e,t){if(!t){return this.options[e]}else{this._u(e,t)}},_setup:function(t,n){this.el=e(n);jQuery.extend(this.options,t);this.options.center=this._latLng(this.options.center);this._create();if(this._init){this._init()}},_create:function(){var e=this.instance={el:this.el,map:new Microsoft.Maps.Map(this.el[0],this.options),markers:[],services:[],overlays:[]};this._call(this.options.callback,e.map);setTimeout(function(){e.el.trigger("init",e.map)},1)},_u:function(e,t){var n=this.get("map");this.options[e]=t;n.setOptions(jQuery.extend(this.options,{center:n.getCenter(),mapTypeId:n.getMapTypeId(),zoom:n.getZoom()}))},addBounds:function(e){var t=this.get("map");var n=this.get("bounds",[]);n.push(this._latLng(e));if(n.length>1){t.setView({bounds:Microsoft.Maps.LocationRect.fromLocations(n)})}else{t.setView({zoom:this.get("map").getZoomRange().max,center:n[0]})}},addControl:function(t,n){var r=this.get("map");var i=e(this._unwrap(t));var s={position:"absolute","z-index":10};if(n<3){s.top=0}else if(n>2&&n<6){s.top=(r.getHeight()-i.height())/2}else if(n>5){s.bottom=0}if(n==0||n==3||n==6){s.left=0}else if(n==1||n==4||n==7){s.left=(r.getWidth()-i.width())/2}else if(n==2||n==5||n==8){s.right=0}i.css(s);this.el[0].appendChild(i[0]);return i},addMarker:function(t,n,r){var i=this.get("map");var r=r||Microsoft.Maps.Pushpin;t=this._convert?this._convert("addMarker",t):t;t.location=this._latLng(t.location);var s=new r(t.location,t);for(var o in t){s[o]=t[o]}var u=this.get("markers",[]);if(s.getId()){u[s.getId()]=s}else{u.push(s)}if(t.bounds){this.addBounds(s.getLocation())}i.entities.push(s);this._call(n,i,s);return e(s)},addInfoWindow:function(t,n,r){var i=new Microsoft.Maps.Infobox(n.getLocation(),t);this.get("map").entities.push(i);this._call(r,i);return e(i)},openInfoWindow:function(e,t){e.offset=e.offset||new Microsoft.Maps.Point(0,15);e.zIndex=e.zIndex||99999;e=this._convert?this._convert("openInfoWindow",e):e;var t=this._unwrap(t),n;if(!t){n=e.location}else if(t instanceof Microsoft.Maps.Pushpin){n=t.getLocation()}else{n=t.target.getLocation()}if(this.get("iw")&&this.get("map").entities.indexOf(this.get("iw"))>-1){this.get("map").entities.remove(this.get("iw"))}if(e.htmlContent){if(e.htmlContent instanceof Object){e.htmlContent='<div class="Infobox">'+e.htmlContent.innerHTML+"</div>"}else{if(e.htmlContent.match(RegExp(/<(?:"[^"]*"['"]*|'[^']*'['"]*|[^'">])+>/))==null){e.description=e.htmlContent}}}this.set("iw",new Microsoft.Maps.Infobox(n,e));this.get("map").entities.push(this.get("iw"));this.get("map").setView({center:n})},clear:function(e){this._c(this.get(e));this.set(e,[])},_c:function(e){for(var t in e){if(e.hasOwnProperty(t)){if(e[t]instanceof Microsoft.Maps.Pushpin||e[t]instanceof Microsoft.Maps.Infobox||e[t]instanceof Microsoft.Maps.Map){Microsoft.Maps.Events.removeHandler(e[t]);this.get("map").entities.remove(e[t])}else if(e[t]instanceof Array){this._c(e[t])}e[t]=null}}},find:function(t,n,r){var i=this.get(t);for(var s in i){if(i.hasOwnProperty(s)){r(i[s],n.delimiter&&i[s][n.property]?e.inArray(n.value,i[s][n.property].split(n.delimiter))>-1:i[s][n.property]===n.value)}}},inViewport:function(e){return this.get("map").getBounds().contains(e.getLocation())},get:function(e,t){var n=this.instance;if(!n[e]){if(e.indexOf(">")>-1){var r=e.replace(/ /g,"").split(">");for(var i=0;i<r.length;i++){if(!n[r[i]]){if(t){n[r[i]]=i+1<r.length?[]:t}else{return null}}n=n[r[i]]}return n}else if(t&&!n[e]){this.set(e,t)}}return n[e]},set:function(e,t){this.instance[e]=t},destroy:function(){this.clear("markers");this.clear("services");this.clear("overlays");var e=this.instance;e.map.dispose();for(var t in e){e[t]=null}jQuery.removeData(this.el[0],"gmap")},_call:function(t){if(t&&e.isFunction(t)){t.apply(this,Array.prototype.slice.call(arguments,1))}},_latLng:function(e){if(e instanceof Microsoft.Maps.Location){return e}else{e=e.replace(/ /g,"").split(",");return new Microsoft.Maps.Location(e[0],e[1])}},_unwrap:function(t){if(!t){return null}else if(t instanceof jQuery){return t[0]}else if(t instanceof Object){return t}return e("#"+t)[0]},search:function(e,n){var i=e.address?e.address:e.point.latitude+","+e.point.longitude;r(t.replace("{0}",i).replace("{1}",this.options.credentials),n)},loadDirections:function(e,t){r(n.replace("{0}",e.origin).replace("{1}",e.destination).replace("{2}",this.options.credentials),t)},displayDirections:function(e,t){var n=this;var r=function(){var r=n.get("services > DirectionsManager",new Microsoft.Maps.Directions.DirectionsManager(n.get("map")));var i=typeof e.origin==="string"?{address:e.origin}:{location:e.origin};var s=typeof e.destination==="string"?{address:e.destination}:{location:e.destination};r.resetDirections();r.setRequestOptions(e.routeMode);r.addWaypoint(new Microsoft.Maps.Directions.Waypoint(i));r.addWaypoint(new Microsoft.Maps.Directions.Waypoint(s));if(t){r.setRenderOptions({itineraryContainer:t.panel})}r.calculateDirections()};if(!n.get("services > DirectionsManager")){Microsoft.Maps.loadModule("Microsoft.Maps.Directions",{callback:r})}else{r()}},addShape:function(t,n){var r=this;e.each(n.paths,function(e,t){n.paths[e]=r._latLng(t)});var i=new Microsoft.Maps[t](n.paths,n);this.get("overlays > "+t,[]).push(i);this.get("map").entities.push(i);return e(i)}});jQuery.fn.extend({click:function(e,t){return this.addEventListener("click",e,t)},rightclick:function(e,t){return this.addEventListener("rightclick",e,t)},dblclick:function(e,t){return this.addEventListener("dblclick",e,t)},mouseover:function(e,t){return this.addEventListener("mouseover",e,t)},mouseout:function(e,t){return this.addEventListener("mouseout",e,t)},drag:function(e){return this.addEventListener("drag",e)},dragend:function(e){return this.addEventListener("dragend",e)},triggerEvent:function(e){Microsoft.Maps.Events.invoke(this[0],e)},addEventListener:function(e,t,n){if(this[0]instanceof Microsoft.Maps.Pushpin||this[0]instanceof Microsoft.Maps.Infobox||this[0]instanceof Microsoft.Maps.Map){Microsoft.Maps.Events.addHandler(this[0],e,t)}else{if(n){this.bind(e,t,n)}else{this.bind(e,t)}}return this}})})(jQuery)